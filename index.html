<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title> Kammanahaill Rider Tracker </title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #333;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 30px;
      color: #2c3e50;
    }
    
    .form-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .search-section {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }
    
    input, select, button {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    input, select {
      width: 100%;
      background: white;
    }
    
    button {
      cursor: pointer;
      background: #007bff;
      color: white;
      border: none;
      transition: background 0.2s;
      white-space: nowrap;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    .btn-danger {
      background: #dc3545;
    }
    
    .btn-danger:hover {
      background: #c82333;
    }
    
    .btn-success {
      background: #28a745;
    }
    
    .btn-success:hover {
      background: #218838;
    }
    
    .btn-secondary {
      background: #6c757d;
    }
    
    .btn-secondary:hover {
      background: #545b62;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    
    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    
    th {
      background: #f8f9fa;
      font-weight: 600;
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    .search-info {
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 4px;
      text-align: center;
    }
    
    .search-found {
      background: #d4edda;
      color: #155724;
    }
    
    .search-notfound {
      background: #f8d7da;
      color: #721c24;
    }
    
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      background: white;
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      width: 300px;
      text-align: center;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .form-section {
        grid-template-columns: 1fr;
      }
      
      .search-section {
        flex-direction: column;
      }
      
      .actions {
        flex-direction: column;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Rider Absconding Tracker</h1>

    <div class="search-section">
      <input id="searchPhone" placeholder="Search by Phone Number" style="flex: 1;" />
      <button onclick="searchByPhone()" class="btn-secondary">Search</button>
      <button onclick="clearSearch()" class="btn-secondary">Clear</button>
    </div>

    <div class="form-section">
      <input id="riderName" placeholder="Rider Name" />
      <input id="orderId" placeholder="Order ID" />
      <input id="orderValue" placeholder="Order Value" />
      <input id="phoneNumber" placeholder="Phone Number" />
      <select id="remarks">
        <option value="Rider Absconded with order">Rider Absconded with order</option>
        <option value="Rider misbehaved with customer">Rider misbehaved with customer</option>
        <option value="Wrong address delivered">Wrong address delivered</option>
        <option value="Other issue">Other issue</option>
      </select>
    </div>

    <div class="actions">
      <button onclick="addOrUpdate()" class="btn-success">Save</button>
      <button onclick="clearForm()" class="btn-secondary">Clear Form</button>
      <button onclick="showPasswordModal('clearAll')" class="btn-danger">Clear All</button>
      <button onclick="exportToExcel()" class="btn-success">Export Excel</button>
    </div>

    <div id="searchResultInfo" class="search-info" style="display: none;"></div>

    <table>
      <thead>
        <tr>
          <th>Sr. No.</th>
          <th>Rider Name</th>
          <th>Order ID</th>
          <th>Order Value</th>
          <th>Phone</th>
          <th>Remarks</th>
          <th>Date</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <tr><td colspan="8" style="text-align:center;">Loading data...</td></tr>
      </tbody>
    </table>

    <!-- Password Modal -->
    <div id="passwordModal" class="modal">
      <div class="modal-content">
        <h3 id="modalTitle">Password Required</h3>
        <p id="modalMessage">Enter password to continue:</p>
        <input type="password" id="passwordInput" placeholder="Enter password" style="width: 90%; margin: 10px 0;" />
        <div>
          <button onclick="verifyPassword()" class="btn-danger" id="confirmButton">Confirm</button>
          <button onclick="closePasswordModal()" class="btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA6fTK2Q5S3o36_fHppMI4a-SzDAbeQYjM",
      authDomain: "kammanahaill-rider-absconding.firebaseapp.com",
      databaseURL: "https://kammanahaill-rider-absconding-default-rtdb.firebaseio.com",
      projectId: "kammanahaill-rider-absconding",
      storageBucket: "kammanahaill-rider-absconding.firebasestorage.app",
      messagingSenderId: "229278595614",
      appId: "1:229278595614:web:fe4af33f045eef16b38c0f",
      measurementId: "G-FEV7T2EVBH"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const dataRef = database.ref("riderAbsconding");

    let snapshotStore = {};
    let editKey = null;
    let isSearching = false;
    let searchResults = {};
    const tableBody = document.getElementById('tableBody');
    const searchResultInfo = document.getElementById('searchResultInfo');

    // Variables for password protection
    let currentAction = '';
    let currentKey = '';
    const PASSWORD = "211225";

    // Initialize the app
    function initApp() {
      console.log("Initializing Rider Tracker App...");
      
      // Listen for data changes
      dataRef.on('value', (snapshot) => {
        console.log("Data received from Firebase:", snapshot.val());
        snapshotStore = snapshot.val() || {};
        
        if (!isSearching) {
          renderTable();
        }
      }, (error) => {
        console.error("Firebase error:", error);
        tableBody.innerHTML = `<tr><td colspan='8' style='text-align:center;color:red;'>Error loading data: ${error.message}</td></tr>`;
      });

      // Add event listener for Enter key in form fields
      const inputs = document.querySelectorAll('input');
      inputs.forEach(input => {
        input.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            addOrUpdate();
          }
        });
      });
    }

    function renderTable() {
      console.log("Rendering table...");
      tableBody.innerHTML = "";
      const dataToRender = isSearching ? searchResults : snapshotStore;
      const keys = Object.keys(dataToRender);
      
      if (keys.length === 0) {
        const message = isSearching ? 
          "No matching records found." : 
          "No data available. Add your first entry above.";
        tableBody.innerHTML = `<tr><td colspan='8' style='text-align:center;'>${message}</td></tr>`;
        return;
      }
      
      // Sort by timestamp (newest first)
      keys.sort((a, b) => {
        const timeA = dataToRender[a].timestamp || "";
        const timeB = dataToRender[b].timestamp || "";
        return timeB.localeCompare(timeA);
      });
      
      // Add serial numbers
      keys.forEach((key, index) => {
        const entry = dataToRender[key];
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${escapeHtml(entry.name || "")}</td>
          <td>${escapeHtml(entry.orderId || "")}</td>
          <td>${escapeHtml(entry.orderValue || "")}</td>
          <td>${escapeHtml(entry.phone || "")}</td>
          <td>${escapeHtml(entry.remarks || "")}</td>
          <td>${escapeHtml(entry.timestamp || "")}</td>
          <td>
            <div class="action-buttons">
              <button class="btn-secondary" onclick="requestEdit('${key}')">Edit</button>
              <button class="btn-danger" onclick="requestDelete('${key}')">Delete</button>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Password protected functions
    function requestEdit(key) {
      console.log("Edit requested for key:", key);
      currentAction = 'edit';
      currentKey = key;
      showPasswordModal('edit');
    }

    function requestDelete(key) {
      console.log("Delete requested for key:", key);
      currentAction = 'delete';
      currentKey = key;
      showPasswordModal('delete');
    }

    function performEdit() {
      console.log("Performing edit for key:", currentKey);
      const dataSource = isSearching ? searchResults : snapshotStore;
      const entry = dataSource[currentKey];
      
      if (!entry) {
        alert("Entry not found!");
        return;
      }

      // Fill the form with existing data
      document.getElementById("riderName").value = entry.name || "";
      document.getElementById("orderId").value = entry.orderId || "";
      document.getElementById("orderValue").value = entry.orderValue || "";
      document.getElementById("phoneNumber").value = entry.phone || "";
      document.getElementById("remarks").value = entry.remarks || "";
      editKey = currentKey;
      
      // Scroll to form
      window.scrollTo({ top: 0, behavior: "smooth" });
      document.getElementById("riderName").focus();
      
      alert("You can now edit the entry. Click 'Save' to update.");
    }

    function performDelete() {
      console.log("Performing delete for key:", currentKey);
      
      database.ref(`riderAbsconding/${currentKey}`).remove()
        .then(() => {
          console.log("Entry deleted successfully");
          alert("Entry deleted successfully!");
          
          // If we're in search mode, also remove from search results
          if (isSearching && searchResults[currentKey]) {
            delete searchResults[currentKey];
          }
        })
        .catch((error) => {
          alert("Error deleting entry: " + error.message);
          console.error("Delete error:", error);
        });
    }

    function showPasswordModal(action) {
      const modal = document.getElementById("passwordModal");
      const title = document.getElementById("modalTitle");
      const message = document.getElementById("modalMessage");
      const confirmBtn = document.getElementById("confirmButton");
      
      switch(action) {
        case 'edit':
          title.textContent = "Edit Entry - Password Required";
          message.textContent = "Enter password to edit this entry:";
          confirmBtn.textContent = "Confirm Edit";
          confirmBtn.className = "btn-secondary";
          break;
        case 'delete':
          title.textContent = "Delete Entry - Password Required";
          message.textContent = "Enter password to delete this entry:";
          confirmBtn.textContent = "Confirm Delete";
          confirmBtn.className = "btn-danger";
          break;
        case 'clearAll':
          title.textContent = "Clear All Data - Password Required";
          message.textContent = "Enter password to clear ALL data:";
          confirmBtn.textContent = "Confirm Clear All";
          confirmBtn.className = "btn-danger";
          break;
        default:
          title.textContent = "Password Required";
          message.textContent = "Enter password to continue:";
          confirmBtn.textContent = "Confirm";
          confirmBtn.className = "btn-primary";
      }
      
      modal.style.display = "block";
      document.getElementById("passwordInput").value = "";
      document.getElementById("passwordInput").focus();
    }

    function closePasswordModal() {
      document.getElementById("passwordModal").style.display = "none";
      // Don't reset currentAction and currentKey here - wait for verifyPassword
    }

    function verifyPassword() {
      const password = document.getElementById("passwordInput").value;
      
      if (password === PASSWORD) {
        closePasswordModal();
        
        switch(currentAction) {
          case 'edit':
            performEdit();
            break;
          case 'delete':
            if (confirm("Are you sure you want to delete this entry? This action cannot be undone.")) {
              performDelete();
            }
            break;
          case 'clearAll':
            clearAll();
            break;
          default:
            console.log("No action specified");
        }
        
        // Reset action variables after completion
        currentAction = '';
        currentKey = '';
        
      } else {
        alert("Incorrect password. Please try again.");
        document.getElementById("passwordInput").value = "";
        document.getElementById("passwordInput").focus();
      }
    }

    function searchByPhone() {
      const searchTerm = document.getElementById("searchPhone").value.trim();
      
      if (!searchTerm) {
        alert("Please enter a phone number to search.");
        return;
      }
      
      console.log("Searching for:", searchTerm);
      
      // Filter entries by phone number
      searchResults = {};
      Object.keys(snapshotStore).forEach(key => {
        const entry = snapshotStore[key];
        if (entry.phone && entry.phone.includes(searchTerm)) {
          searchResults[key] = entry;
        }
      });
      
      isSearching = true;
      
      // Show search result info
      const resultCount = Object.keys(searchResults).length;
      if (resultCount > 0) {
        searchResultInfo.textContent = `Found ${resultCount} record(s) matching phone number: ${searchTerm}`;
        searchResultInfo.className = "search-info search-found";
        searchResultInfo.style.display = "block";
      } else {
        searchResultInfo.textContent = `No records found matching phone number: ${searchTerm}`;
        searchResultInfo.className = "search-info search-notfound";
        searchResultInfo.style.display = "block";
      }
      
      renderTable();
    }

    function clearSearch() {
      isSearching = false;
      searchResults = {};
      document.getElementById("searchPhone").value = "";
      searchResultInfo.style.display = "none";
      renderTable();
    }

    function addOrUpdate() {
      const name = document.getElementById("riderName").value.trim();
      const orderId = document.getElementById("orderId").value.trim();
      const orderValue = document.getElementById("orderValue").value.trim();
      const phone = document.getElementById("phoneNumber").value.trim();
      const remarks = document.getElementById("remarks").value;
      
      // Validation
      if (!name || !orderId || !orderValue || !phone) { 
        alert("Please fill all required fields (Rider Name, Order ID, Order Value, and Phone Number)."); 
        return; 
      }
      
      const entry = { 
        name, 
        orderId, 
        orderValue, 
        phone, 
        remarks, 
        timestamp: new Date().toLocaleString('en-IN') 
      };
      
      console.log("Saving entry:", entry);
      
      if (editKey) {
        // Update existing entry
        database.ref(`riderAbsconding/${editKey}`).update(entry)
          .then(() => {
            alert("Entry updated successfully!");
            clearForm();
            editKey = null;
          })
          .catch((error) => {
            alert("Error updating entry: " + error.message);
            console.error("Update error:", error);
          });
      } else {
        // Add new entry
        dataRef.push(entry)
          .then(() => {
            alert("Entry added successfully!");
            clearForm();
          })
          .catch((error) => {
            alert("Error adding entry: " + error.message);
            console.error("Add error:", error);
          });
      }
    }

    function clearForm() {
      document.getElementById("riderName").value = "";
      document.getElementById("orderId").value = "";
      document.getElementById("orderValue").value = "";
      document.getElementById("phoneNumber").value = "";
      document.getElementById("remarks").selectedIndex = 0;
      editKey = null;
    }

    function clearAll() {
      if (confirm("Are you sure you want to delete ALL entries? This action cannot be undone.")) {
        dataRef.remove()
          .then(() => {
            alert("All entries deleted successfully.");
            clearSearch(); // Also clear any active search
          })
          .catch((error) => {
            alert("Error deleting entries: " + error.message);
            console.error("Clear all error:", error);
          });
      }
    }

    function exportToExcel() {
      const dataToExport = isSearching ? searchResults : snapshotStore;
      const entries = Object.values(dataToExport);
      
      if (entries.length === 0) {
        alert("No data available to export.");
        return;
      }
      
      const header = ["Sr. No.", "Rider Name", "Order ID", "Order Value", "Phone", "Remarks", "Date"];
      const rows = entries.map((entry, index) => [
        index + 1,
        entry.name || "",
        entry.orderId || "",
        entry.orderValue || "",
        entry.phone || "",
        entry.remarks || "",
        entry.timestamp || ""
      ]);
      
      let csvContent = "data:text/csv;charset=utf-8,";
      
      // Add header
      csvContent += header.join(",") + "\r\n";
      
      // Add rows
      rows.forEach(row => {
        csvContent += row.map(cell => `"${cell}"`).join(",") + "\r\n";
      });
      
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      
      const fileName = isSearching ? 
        `rider_absconding_search_${new Date().toISOString().slice(0,10)}.csv` :
        `rider_absconding_${new Date().toISOString().slice(0,10)}.csv`;
      
      link.setAttribute("download", fileName);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', function() {
      initApp();
    });

    // Make functions available globally
    window.addOrUpdate = addOrUpdate;
    window.clearForm = clearForm;
    window.showPasswordModal = showPasswordModal;
    window.closePasswordModal = closePasswordModal;
    window.verifyPassword = verifyPassword;
    window.clearAll = clearAll;
    window.exportToExcel = exportToExcel;
    window.searchByPhone = searchByPhone;
    window.clearSearch = clearSearch;
    window.requestEdit = requestEdit;
    window.requestDelete = requestDelete;
  </script>
</body>
</html>
